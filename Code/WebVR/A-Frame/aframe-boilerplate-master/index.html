<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Hello, World! - A-Frame</title>
    <meta name="description" content="Hello, World! - A-Frame">
    <script src="https://aframe.io/releases/0.5.0/aframe.min.js"></script>

    <style type="text/css">
    	p{
    		color: red;
    	}

    	body{
    		background-color: white;
    	}

    	.float{
    		float: right;
    	}

    	.bluediv{
    		width: 300px;
    		margin: auto;
    		background-color: blue;
    	}

    	a-text{
    		background-color: red;
    	}
    </style>

  </head>
  <body>
    <h1>Title 1</h1>
    <h3>Title 3</h3>
    <p id="sometext">Text</p>

    <div id="bluediv" class="bluediv">
    	<h2>A DIV</h2>
    	<p>A p in a div</p>
    </div>

    <img src="owl.jpg">
    <h2 class="float">Float</h2>
    <br>
    <button onclick="element = document.getElementById('bluediv'); element.style.float = 'left';">Possition</button>
    <button onclick="element = document.getElementById('sometext'); element.style.color = 'blue';">Text color</button>
    <button onclick="element = document.getElementById('sometext'); element.innerHTML = 'whut?';">Change Text</button>
    <button onclick="element = document.getElementById('bluediv'); element.style.backgroundColor = 'green';">Background color</button>
    <button onclick="element = document.getElementById('bluediv'); element.style.width = '500px';">DIV Size</button>
    <button onclick="element = document.getElementById('sometext'); element.style.fontSize = '50px';">Text Size</button>
    <br>
    
    <script type="text/javascript">

    var pixels_in_one_unit,pixel_text_size;
    //Standard z index
    var z_index = -40;
    //Width of the body
    var body_width;

    class Element{
    	constructor(domelement){
    		this.domelement = domelement;
    		this.aelement = null;
    	}

    	getAElement(){
    		return this.aelement;
    	}

    	getDomElement(){
    		return this.domelement;
    	}
    }

    class TextElement extends Element{
    	constructor(domelement){
    		super(domelement);

    		this.aelement = document.createElement("a-text");
    		this.update();

    		var observer = new MutationObserver(this.update.bind(this));
    		observer.observe(this.domelement, { attributes: true, childList: true, characterData: true, subtree: true});
    	}

    	update(){
    		var element_style = window.getComputedStyle(this.domelement);
			var position = this.domelement.getBoundingClientRect();

			this.aelement.setAttribute("anchor","align");
			
			//Calc the y possition
            var y = -((position.bottom - position.top) / 2 + position.top);
            this.aelement.setAttribute("position",{x: position.left/pixels_in_one_unit, y: y/pixels_in_one_unit, z: z_index});

            //Style attributes
            this.aelement.setAttribute("text","value: " + this.domelement.innerHTML + ";");
    		this.aelement.setAttribute('color', element_style.getPropertyValue("color"));
            //par.setAttribute("font","Times New Toman")//element_style.getPropertyValue("font"));

			//Set width first to 0, else it will get set to 0 after the new width is set
            this.aelement.setAttribute("width",0);
            var scale = pixel_text_size * parseFloat(element_style.getPropertyValue("font-size"));
            this.aelement.setAttribute("width",scale * 20);
    	}
    }

    class ContainerElement extends Element{
    	constructor(domelement, depth){
    		super(domelement);

    		this.div_depth = depth;

    		this.aelement = document.createElement("a-plane");
    		this.update();

    		var observer = new MutationObserver(this.update.bind(this));
    		observer.observe(this.domelement, { attributes: true, childList: true, characterData: true, subtree: true});
    	}

    	update(){
    		var element_style = window.getComputedStyle(this.domelement);
			var position = this.domelement.getBoundingClientRect();

    		var width = (position.right - position.left)/pixels_in_one_unit;
			var height = (position.bottom - position.top)/pixels_in_one_unit;

			if(element.tagName == "BODY")
				body_width = width;

			this.aelement.setAttribute("width", width);
			this.aelement.setAttribute("height", height);
			this.aelement.setAttribute('color', element_style.getPropertyValue("background-color"));

			var y = -position.top/pixels_in_one_unit - height/2;

			this.aelement.setAttribute('position', {x: position.left/pixels_in_one_unit + width/2, y: y, z: z_index + this.div_depth});
    	}
    }

    window.onload = function(){
    	items = new Array(document.body);
    	var doc_items = document.body.getElementsByTagName("*");

    	for(var i = 0; i < doc_items.length; i++)
    		items.push(doc_items[i]);


    	var a_scene = document.createElement("a-scene");

        //Sky
        var a_sky = document.createElement("a-sky");
        a_sky.setAttribute("color", "#DDDDDD");
        a_scene.appendChild(a_sky);

        //Assets
        var a_assets = document.createElement("a-assets");
        a_scene.appendChild(a_assets);

        var img_id = 0;
        var div_depth = -0.2;

        //Calc the ammount of pixels in 1 meter
		var standard_p = document.createElement("p");
		standard_p.setAttribute("style", "font-size:1em;")
        document.body.appendChild(standard_p);
        pixels_in_one_unit = parseFloat(window.getComputedStyle(standard_p).getPropertyValue("font-size"));
        pixel_text_size = 1/pixels_in_one_unit;
        document.body.removeChild(standard_p);

		for (i = 0; i < items.length; i++) {

			element = items[i];
			console.log(element);
			element_style = window.getComputedStyle(element);
			position = element.getBoundingClientRect();

			var aelement = null;

			if(element.tagName == "BODY" || element.tagName == "DIV" ){
				/*var pane = document.createElement("a-plane");

				width = (position.right - position.left)/pixels_in_one_unit;
				height = (position.bottom - position.top)/pixels_in_one_unit;

				if(element.tagName == "BODY")
					body_width = width;

				pane.setAttribute("width", width);
				pane.setAttribute("height", height);
				pane.setAttribute('color', element_style.getPropertyValue("background-color"));

				y = -position.top/pixels_in_one_unit - height/2;

				pane.setAttribute('position', {x: position.left/pixels_in_one_unit + width/2, y: y, z: z_index + div_depth});
				div_depth += 0.05;

				if(div_depth > 0.9)
					div_depth = 0.9;

				a_scene.appendChild(pane);
				aelement = pane;*/

				containerelement = new ContainerElement(element);
	    		a_scene.appendChild(containerelement.getAElement());

	    		div_depth += 0.05;

				if(div_depth > 0.9)
					div_depth = 0.9;
			}	

        	//Text based elements
		    if(element.tagName == "P" || element.tagName.startsWith("H")){
	    		textelement = new TextElement(element);
	    		a_scene.appendChild(textelement.getAElement());
		    }

            //Images
            if(element.tagName == "IMG"){
              var asset = element.cloneNode(true);
              var asset_id = "img-asset-" + img_id++;

              asset.setAttribute("id",asset_id);
              a_assets.appendChild(asset);

              var img = document.createElement("a-image");
              img.setAttribute("src","#"+asset_id);

              img_width = element.clientWidth / pixels_in_one_unit;
              img_height = element.clientHeight / pixels_in_one_unit;
              img.setAttribute("width",img_width);
              img.setAttribute("height",img_height);

              img.setAttribute('position', {x: position.left/pixels_in_one_unit + img_width/2, y: -position.top/pixels_in_one_unit - img_height/2, z: z_index})

              a_scene.appendChild(img);
              aelement = img;
            }

            //element.style.display="none";
		}

		//Camera
		camera_entity = document.createElement("a-entity");
		camera_entity.setAttribute("position", body_width/2 + " 0 0");
		camera = document.createElement("a-camera");
		camera.setAttribute("position", "0 0 0");
		camera_entity.appendChild(camera);

		a_scene.appendChild(camera_entity);

    	document.body.appendChild(a_scene);
    };

    document.onkeydown = checkKey;

	function checkKey(e) {

	    e = e || window.event;

	    if (e.keyCode == '65') {
	    	var pos = camera.getAttribute("position");
	        camera.setAttribute("position", pos.x+ " "+ (pos.y + 2) +" "+ pos.z);
	    }
	    else if (e.keyCode == '69') {
	        var pos = camera.getAttribute("position");
	        camera.setAttribute("position", pos.x+ " "+ (pos.y - 2) +" "+ pos.z);
	    }

	}

    /*setTimeout(function(){
    	elements = document.getElementsByTagName("a-text");
    	for(i = 0; i < elements.length; i++){
    		element = elements[i];

    		pos = element.getAttribute("position");
    		x = pos.x + 0;
    		y = pos.y + 3;
    		z = pos.z + 0;
    		element.setAttribute("position", x+" "+y+" "+z);
    	}
    },3000);*/

    /*setTimeout(function(){
    	elements = document.getElementsByTagName("a-text");
    	for(i = 0; i < elements.length; i++){
    		element = elements[i];
    		element.setAttribute("width", 20);
    	}
    },3000);*/

    </script>
  </body>

</html>
